# Backup & Restore Modul - Technische Dokumentation

## Inhaltsverzeichnis

1. [Ãœbersicht](#Ã¼bersicht)
2. [Architektur](#architektur)
3. [Datenbankstruktur](#datenbankstruktur)
4. [Export-Flow](#export-flow)
5. [Import-Flow](#import-flow)
6. [Sicherheitskonzept](#sicherheitskonzept)
7. [API-Referenz](#api-referenz)
8. [Backup-Dateiformat](#backup-dateiformat)
9. [Entity-Transformers](#entity-transformers)
10. [Fehlerbehandlung](#fehlerbehandlung)

---

## Ãœbersicht

Das Backup & Restore Modul ermÃ¶glicht es Mandanten (Tenants), vollstÃ¤ndige Datensicherungen ihrer Firmendaten zu erstellen und wiederherzustellen. Das System ist fÃ¼r die GoBD-Compliance konzipiert und unterstÃ¼tzt:

- **VollstÃ¤ndige Datenexporte** aller GeschÃ¤ftsdaten
- **Dateiexporte** (Belegfotos, Dokumente)
- **Sichere Wiederherstellung** mit Pre-Restore-Backup
- **Audit-Logging** aller Backup-AktivitÃ¤ten

### Kernprinzipien

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKUP-PRINZIPIEN                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ“ Tenant-Isolation    - Backups sind mandantenspezifisch   â”‚
â”‚  âœ“ Referenzielle Int.  - public_id statt interner IDs      â”‚
â”‚  âœ“ Streaming           - Memory-effizient fÃ¼r groÃŸe Daten  â”‚
â”‚  âœ“ Atomare Ops         - Transaktionen fÃ¼r Konsistenz      â”‚
â”‚  âœ“ Audit-Trail         - Alle Aktionen werden protokolliertâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Architektur

### KomponentenÃ¼bersicht

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              FRONTEND                                    â”‚
â”‚                    BackupManagement.tsx (React)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            API LAYER                                     â”‚
â”‚                    BackupController.php                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ startExport â”‚  listJobs   â”‚ getDownload â”‚ uploadImportâ”‚ startImportâ”‚â”‚
â”‚  â”‚             â”‚             â”‚     Url     â”‚             â”‚            â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SERVICE LAYER                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚   BackupExportService  â”‚    â”‚   BackupImportService  â”‚               â”‚
â”‚  â”‚  - createExport()      â”‚    â”‚  - uploadBackup()      â”‚               â”‚
â”‚  â”‚  - processExport()     â”‚    â”‚  - validateBackup()    â”‚               â”‚
â”‚  â”‚  - deleteBackup()      â”‚    â”‚  - processImport()     â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                â”‚                          â”‚                             â”‚
â”‚                â–¼                          â–¼                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚            EntityTransformerRegistry                     â”‚            â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚            â”‚
â”‚  â”‚  â”‚ Invoices     â”‚ Contacts     â”‚ JournalEntries  ...  â”‚ â”‚            â”‚
â”‚  â”‚  â”‚ Transformer  â”‚ Transformer  â”‚ Transformer          â”‚ â”‚            â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           JOB LAYER                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ ProcessBackupExportJob â”‚    â”‚ ProcessBackupImportJob â”‚               â”‚
â”‚  â”‚  - Queue: backups      â”‚    â”‚  - Queue: backups      â”‚               â”‚
â”‚  â”‚  - Timeout: 1h         â”‚    â”‚  - Timeout: 2h         â”‚               â”‚
â”‚  â”‚  - WithoutOverlapping  â”‚    â”‚  - WithoutOverlapping  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          DATA LAYER                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ BackupJob   â”‚ â”‚ BackupAuditLog  â”‚ â”‚ All Tenant Models with public_idâ”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Verzeichnisstruktur

```
app/
â”œâ”€â”€ Http/Controllers/Api/
â”‚   â””â”€â”€ BackupController.php          # API Endpoints
â”œâ”€â”€ Jobs/
â”‚   â”œâ”€â”€ ProcessBackupExportJob.php    # Async Export
â”‚   â””â”€â”€ ProcessBackupImportJob.php    # Async Import
â”œâ”€â”€ Models/
â”‚   â”œâ”€â”€ BackupJob.php                 # Job-Tracking Model
â”‚   â”œâ”€â”€ BackupAuditLog.php            # Audit-Logging Model
â”‚   â””â”€â”€ Concerns/
â”‚       â””â”€â”€ HasPublicId.php           # Trait fÃ¼r UUID public_id
â”œâ”€â”€ Services/Backup/
â”‚   â”œâ”€â”€ BackupExportService.php       # Export-Logik
â”‚   â”œâ”€â”€ BackupImportService.php       # Import-Logik
â”‚   â”œâ”€â”€ DTO/
â”‚   â”‚   â””â”€â”€ ImportIdMapping.php       # ID-Mapping beim Import
â”‚   â””â”€â”€ Transformers/
â”‚       â”œâ”€â”€ BaseTransformer.php       # Basis-Transformer
â”‚       â”œâ”€â”€ EntityTransformerRegistry.php
â”‚       â”œâ”€â”€ InvoiceTransformer.php
â”‚       â”œâ”€â”€ ContactTransformer.php
â”‚       â””â”€â”€ ... (20+ Transformers)
â””â”€â”€ Providers/
    â””â”€â”€ AppServiceProvider.php        # Gate: backup-manage

resources/js/components/
â””â”€â”€ BackupManagement.tsx              # React UI-Komponente

database/migrations/
â”œâ”€â”€ create_backup_jobs_table.php
â”œâ”€â”€ create_backup_audit_logs_table.php
â””â”€â”€ add_public_id_to_all_tenant_models.php
```

---

## Datenbankstruktur

### BackupJob

```sql
CREATE TABLE backup_jobs (
    id BIGSERIAL PRIMARY KEY,
    tenant_id BIGINT NOT NULL REFERENCES tenants(id),
    user_id BIGINT NOT NULL REFERENCES users(id),
    public_id UUID UNIQUE NOT NULL,
    type VARCHAR(20) NOT NULL,           -- 'export' | 'import'
    status VARCHAR(20) NOT NULL,         -- 'pending' | 'processing' | 'completed' | 'failed' | 'cancelled'
    progress_percent INTEGER DEFAULT 0,
    current_step VARCHAR(255),
    file_path VARCHAR(255),
    file_size BIGINT,
    checksum VARCHAR(64),                -- SHA-256
    options JSONB DEFAULT '{}',
    stats JSONB,
    error_message TEXT,
    error_details JSONB,
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

### BackupAuditLog

```sql
CREATE TABLE backup_audit_logs (
    id BIGSERIAL PRIMARY KEY,
    tenant_id BIGINT NOT NULL REFERENCES tenants(id),
    user_id BIGINT REFERENCES users(id),
    backup_job_id BIGINT REFERENCES backup_jobs(id),
    action VARCHAR(50) NOT NULL,
    metadata JSONB,
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at TIMESTAMP
);
```

### Audit-Aktionen

| Aktion | Beschreibung |
|--------|--------------|
| `export_started` | Export wurde gestartet |
| `export_completed` | Export erfolgreich abgeschlossen |
| `export_failed` | Export fehlgeschlagen |
| `export_downloaded` | Backup wurde heruntergeladen |
| `import_uploaded` | Backup-Datei hochgeladen |
| `import_validated` | Backup wurde validiert |
| `import_started` | Import wurde gestartet |
| `import_completed` | Import erfolgreich abgeschlossen |
| `import_failed` | Import fehlgeschlagen |
| `pre_restore_backup` | Automatisches Pre-Restore-Backup erstellt |

---

## Export-Flow

### Ãœbersichtsdiagramm

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         EXPORT WORKFLOW                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  User   â”‚
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚ klickt "Backup erstellen"
          â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ POST /api/      â”‚
     â”‚ backup/export   â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ BackupController::startExport()        â”‚
     â”‚  1. Authorization: backup-manage Gate  â”‚
     â”‚  2. Check: Kein laufender Export?      â”‚
     â”‚  3. Create BackupJob (status: pending) â”‚
     â”‚  4. Dispatch ProcessBackupExportJob    â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼ (async in Queue)
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                    ProcessBackupExportJob                           â”‚
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
     â”‚  â”‚ BackupExportService::processExport()                            â”‚â”‚
     â”‚  â”‚                                                                 â”‚â”‚
     â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚â”‚
     â”‚  â”‚  â”‚ 1. Init     â”‚ markAsProcessing(), createTempDir()            â”‚â”‚
     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                â”‚â”‚
     â”‚  â”‚         â–¼                                                       â”‚â”‚
     â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
     â”‚  â”‚  â”‚ 2. Metadata â”‚ Erstelle metadata.json                        â”‚â”‚â”‚
     â”‚  â”‚  â”‚             â”‚ - backup_version, app_version                 â”‚â”‚â”‚
     â”‚  â”‚  â”‚             â”‚ - tenant_public_id, tenant_name               â”‚â”‚â”‚
     â”‚  â”‚  â”‚             â”‚ - schema_version, created_at                  â”‚â”‚â”‚
     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
     â”‚  â”‚         â–¼                                                       â”‚â”‚
     â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
     â”‚  â”‚  â”‚ 3. Entities â”‚ FÃ¼r jeden EntityType in ENTITY_ORDER:         â”‚â”‚â”‚
     â”‚  â”‚  â”‚             â”‚   - Hole Transformer                          â”‚â”‚â”‚
     â”‚  â”‚  â”‚             â”‚   - Query: model->where(tenant_id)->cursor()  â”‚â”‚â”‚
     â”‚  â”‚  â”‚             â”‚   - Transform â†’ NDJSON schreiben              â”‚â”‚â”‚
     â”‚  â”‚  â”‚             â”‚   - Progress aktualisieren                    â”‚â”‚â”‚
     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
     â”‚  â”‚         â–¼                                                       â”‚â”‚
     â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
     â”‚  â”‚  â”‚ 4. Files    â”‚ Kopiere Beleg-Dateien, Dokumente              â”‚â”‚â”‚
     â”‚  â”‚  â”‚             â”‚ - Erstelle file manifest                      â”‚â”‚â”‚
     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
     â”‚  â”‚         â–¼                                                       â”‚â”‚
     â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
     â”‚  â”‚  â”‚ 5. Manifest â”‚ Erstelle manifest.json                        â”‚â”‚â”‚
     â”‚  â”‚  â”‚             â”‚ - entities[], files[], checksums              â”‚â”‚â”‚
     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
     â”‚  â”‚         â–¼                                                       â”‚â”‚
     â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
     â”‚  â”‚  â”‚ 6. ZIP      â”‚ Komprimiere alles zu .zip                     â”‚â”‚â”‚
     â”‚  â”‚  â”‚             â”‚ - Berechne SHA-256 Checksum                   â”‚â”‚â”‚
     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
     â”‚  â”‚         â–¼                                                       â”‚â”‚
     â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
     â”‚  â”‚  â”‚ 7. Store    â”‚ Verschiebe ZIP zu permanentem Storage         â”‚â”‚â”‚
     â”‚  â”‚  â”‚             â”‚ markAsCompleted(path, size, checksum, stats)  â”‚â”‚â”‚
     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Frontend pollt alle 2s GET /jobs       â”‚
     â”‚ Zeigt Progress-Bar und Status          â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ status === 'completed'
              â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ User klickt Download-Button            â”‚
     â”‚  1. GET /jobs/{id}/download-url        â”‚
     â”‚  2. Signierte URL wird generiert       â”‚
     â”‚  3. Browser Ã¶ffnet URL in neuem Tab    â”‚
     â”‚  4. GET /backup/download/{id}?token=x  â”‚
     â”‚  5. ZIP wird heruntergeladen           â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Entity-Reihenfolge (ENTITY_ORDER)

Die EntitÃ¤ten werden in einer spezifischen Reihenfolge exportiert, um AbhÃ¤ngigkeiten zu respektieren:

```
1.  tenants              # Mandant (nur eigener)
2.  users                # Benutzer
3.  accounts             # Kontenrahmen
4.  tax_codes            # SteuerschlÃ¼ssel
5.  product_categories   # Produktkategorien
6.  products             # Produkte/Artikel
7.  contacts             # Kontakte (Kunden/Lieferanten)
8.  bank_accounts        # Bankkonten
9.  company_settings     # Firmeneinstellungen
10. quotes               # Angebote
11. quote_lines          # Angebotspositionen
12. orders               # AuftrÃ¤ge
13. order_lines          # Auftragspositionen
14. delivery_notes       # Lieferscheine
15. delivery_note_lines  # Lieferscheinpositionen
16. invoices             # Rechnungen
17. invoice_lines        # Rechnungspositionen
18. belege               # Belege (Eingangs-/Ausgangsrechnungen)
19. beleg_lines          # Belegpositionen
20. journal_entries      # BuchungssÃ¤tze
21. journal_entry_lines  # Buchungszeilen
22. inventory_transactions # Lagerbewegungen
```

---

## Import-Flow

### Ãœbersichtsdiagramm

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         IMPORT WORKFLOW                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  User   â”‚
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚ klickt "Wiederherstellen"
          â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Dialog: Datei auswÃ¤hlen (.zip)         â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ POST /api/backup/import/upload         â”‚
     â”‚ (multipart/form-data)                  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ BackupImportService::uploadBackup()    â”‚
     â”‚  1. Speichere ZIP in backup_uploads/   â”‚
     â”‚  2. Erstelle BackupJob (type: import)  â”‚
     â”‚  3. Berechne Checksum                  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ User klickt "Backup validieren"        â”‚
     â”‚ POST /api/backup/import/{id}/validate  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚              BackupImportService::validateBackup()                  â”‚
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
     â”‚  â”‚ 1. ZIP Ã¶ffnen                                                   â”‚â”‚
     â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
     â”‚  â”‚ 2. PrÃ¼fe: metadata.json vorhanden?                              â”‚â”‚
     â”‚  â”‚    - backup_version                                             â”‚â”‚
     â”‚  â”‚    - app_version                                                â”‚â”‚
     â”‚  â”‚    - tenant_public_id (MUSS Ã¼bereinstimmen!)                    â”‚â”‚
     â”‚  â”‚    - schema_version                                             â”‚â”‚
     â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
     â”‚  â”‚ 3. PrÃ¼fe: manifest.json vorhanden?                              â”‚â”‚
     â”‚  â”‚    - Anzahl EntitÃ¤ten                                           â”‚â”‚
     â”‚  â”‚    - Anzahl Dateien                                             â”‚â”‚
     â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
     â”‚  â”‚ 4. Path Traversal Check                                         â”‚â”‚
     â”‚  â”‚    - Keine "../" in Dateipfaden                                 â”‚â”‚
     â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
     â”‚  â”‚ 5. TENANT-CHECK (KRITISCH!)                                     â”‚â”‚
     â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚â”‚
     â”‚  â”‚    â”‚ IF backup.tenant_public_id !== current.tenant_public_idâ”‚   â”‚â”‚
     â”‚  â”‚    â”‚ THEN â†’ ERROR: Cross-Tenant Import nicht erlaubt!       â”‚   â”‚â”‚
     â”‚  â”‚    â”‚ ELSE â†’ OK, Import kann fortgesetzt werden              â”‚   â”‚â”‚
     â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚â”‚
     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Zeige Validierungsergebnis:            â”‚
     â”‚ - Backup-Infos (Version, Datum, etc.)  â”‚
     â”‚ - Warnungen (falls vorhanden)          â”‚
     â”‚ - FEHLER (blockiert Import)            â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ valid === true
              â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Dialog: Passwort-BestÃ¤tigung           â”‚
     â”‚ "Geben Sie Ihr Passwort ein"           â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ POST /api/backup/import/{id}/start     â”‚
     â”‚ { confirm_password: "xxx" }            â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Passwort-Verifikation                  â”‚
     â”‚ Hash::check(password, user.password)   â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ OK
              â–¼ (async in Queue)
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                    ProcessBackupImportJob                           â”‚
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
     â”‚  â”‚ BackupImportService::processImport()                            â”‚â”‚
     â”‚  â”‚                                                                 â”‚â”‚
     â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
     â”‚  â”‚  â”‚ 1. PRE-RESTORE BACKUP (automatisch!)                        â”‚â”‚â”‚
     â”‚  â”‚  â”‚    BackupExportService::processExport()                     â”‚â”‚â”‚
     â”‚  â”‚  â”‚    â†’ Erstellt Sicherung VOR dem Ãœberschreiben              â”‚â”‚â”‚
     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
     â”‚  â”‚         â–¼                                                       â”‚â”‚
     â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
     â”‚  â”‚  â”‚ 2. EXTRACT ZIP                                              â”‚â”‚â”‚
     â”‚  â”‚  â”‚    â†’ Entpacke nach /tmp/at-book-import-{id}/                â”‚â”‚â”‚
     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
     â”‚  â”‚         â–¼                                                       â”‚â”‚
     â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
     â”‚  â”‚  â”‚ 3. DELETE EXISTING DATA                                     â”‚â”‚â”‚
     â”‚  â”‚  â”‚    a) LÃ¶sche Child-Tabellen (via Parent FK):                â”‚â”‚â”‚
     â”‚  â”‚  â”‚       - quote_lines, order_lines, invoice_lines, etc.       â”‚â”‚â”‚
     â”‚  â”‚  â”‚    b) LÃ¶sche Parent-Tabellen (mit tenant_id):               â”‚â”‚â”‚
     â”‚  â”‚  â”‚       - invoices, orders, contacts, etc.                    â”‚â”‚â”‚
     â”‚  â”‚  â”‚    âš ï¸ WICHTIG: Aktueller User wird NICHT gelÃ¶scht!         â”‚â”‚â”‚
     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
     â”‚  â”‚         â–¼                                                       â”‚â”‚
     â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
     â”‚  â”‚  â”‚ 4. IMPORT ENTITIES                                          â”‚â”‚â”‚
     â”‚  â”‚  â”‚    FÃ¼r jeden EntityType in ENTITY_ORDER:                    â”‚â”‚â”‚
     â”‚  â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚â”‚
     â”‚  â”‚  â”‚    â”‚ a) Lade NDJSON Datei                                â”‚  â”‚â”‚â”‚
     â”‚  â”‚  â”‚    â”‚ b) FÃ¼r jede Zeile:                                  â”‚  â”‚â”‚â”‚
     â”‚  â”‚  â”‚    â”‚    - Parse JSON                                     â”‚  â”‚â”‚â”‚
     â”‚  â”‚  â”‚    â”‚    - Map Foreign Keys (public_id â†’ internal_id)     â”‚  â”‚â”‚â”‚
     â”‚  â”‚  â”‚    â”‚    - Setze tenant_id (nur Parent-Tabellen)          â”‚  â”‚â”‚â”‚
     â”‚  â”‚  â”‚    â”‚    - Spezialfall Users:                             â”‚  â”‚â”‚â”‚
     â”‚  â”‚  â”‚    â”‚      IF email bereits existiert â†’ Skip & Map ID     â”‚  â”‚â”‚â”‚
     â”‚  â”‚  â”‚    â”‚    - Create Model ohne Events                       â”‚  â”‚â”‚â”‚
     â”‚  â”‚  â”‚    â”‚    - Speichere ID-Mapping                           â”‚  â”‚â”‚â”‚
     â”‚  â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚â”‚
     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
     â”‚  â”‚         â–¼                                                       â”‚â”‚
     â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
     â”‚  â”‚  â”‚ 5. IMPORT FILES                                             â”‚â”‚â”‚
     â”‚  â”‚  â”‚    - Kopiere Dateien zurÃ¼ck in Storage                      â”‚â”‚â”‚
     â”‚  â”‚  â”‚    - Verwende original_path aus Manifest                    â”‚â”‚â”‚
     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
     â”‚  â”‚         â–¼                                                       â”‚â”‚
     â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
     â”‚  â”‚  â”‚ 6. CLEANUP                                                  â”‚â”‚â”‚
     â”‚  â”‚  â”‚    - LÃ¶sche temporÃ¤res Verzeichnis                          â”‚â”‚â”‚
     â”‚  â”‚  â”‚    - markAsCompleted()                                      â”‚â”‚â”‚
     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ID-Mapping beim Import

Da interne IDs bei Backup/Restore unterschiedlich sein kÃ¶nnen, verwendet das System `public_id` (UUIDs) fÃ¼r Referenzen:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ID MAPPING                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  BACKUP-DATEI (NDJSON)              â†’        NEUE DATENBANK             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•            â”‚
â”‚                                                                         â”‚
â”‚  invoices.ndjson:                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚ {                             â”‚                                      â”‚
â”‚  â”‚   "public_id": "abc-123",     â”‚   â†’   Invoice #42                    â”‚
â”‚  â”‚   "contact_public_id": "xyz"  â”‚   â†’   contact_id: 17                 â”‚
â”‚  â”‚ }                             â”‚       (gemappt via ImportIdMapping)  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                                                                         â”‚
â”‚  ImportIdMapping:                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  entity_type     â”‚  public_id  â”‚  internal_id                       â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚  contacts        â”‚  "xyz"      â”‚  17                                â”‚â”‚
â”‚  â”‚  invoices        â”‚  "abc-123"  â”‚  42                                â”‚â”‚
â”‚  â”‚  products        â”‚  "prod-1"   â”‚  5                                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Sicherheitskonzept

### Authentifizierung & Autorisierung

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SICHERHEITSEBENEN                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  1. API-AUTHENTIFIZIERUNG                                               â”‚
â”‚     â”œâ”€â”€ JWT Token erforderlich fÃ¼r alle Backup-Endpoints               â”‚
â”‚     â””â”€â”€ Middleware: auth:api                                           â”‚
â”‚                                                                         â”‚
â”‚  2. AUTORISIERUNG (Gate)                                                â”‚
â”‚     â”œâ”€â”€ Gate: 'backup-manage'                                          â”‚
â”‚     â””â”€â”€ Nur Benutzer mit Rolle 'owner' oder 'admin'                    â”‚
â”‚                                                                         â”‚
â”‚  3. TENANT-ISOLATION                                                    â”‚
â”‚     â”œâ”€â”€ Backups sind strikt mandantenspezifisch                        â”‚
â”‚     â”œâ”€â”€ Cross-Tenant Import ist BLOCKIERT                              â”‚
â”‚     â””â”€â”€ Alle Queries gefiltert nach tenant_id                          â”‚
â”‚                                                                         â”‚
â”‚  4. RE-AUTHENTIFIZIERUNG (fÃ¼r Import)                                   â”‚
â”‚     â”œâ”€â”€ Passwort muss vor destructive Import bestÃ¤tigt werden          â”‚
â”‚     â””â”€â”€ Hash::check() Verifikation                                     â”‚
â”‚                                                                         â”‚
â”‚  5. SIGNIERTE DOWNLOAD-URLs                                             â”‚
â”‚     â”œâ”€â”€ Download-Links sind temporÃ¤r (5 Minuten)                       â”‚
â”‚     â”œâ”€â”€ Token wird im Cache gespeichert                                â”‚
â”‚     â””â”€â”€ One-time-use (Token wird nach Download gelÃ¶scht)               â”‚
â”‚                                                                         â”‚
â”‚  6. PATH TRAVERSAL SCHUTZ                                               â”‚
â”‚     â”œâ”€â”€ ZIP-Dateien werden auf "../" und "//" geprÃ¼ft                  â”‚
â”‚     â””â”€â”€ Verhindert Zugriff auf Systemdateien                           â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Audit-Logging

Jede Backup-Aktion wird protokolliert:

```php
BackupAuditLog::log(
    action: 'export_completed',
    job: $backupJob,
    metadata: ['file_size' => 1024000, 'stats' => [...]]
);
```

Protokollierte Daten:
- `tenant_id` - Mandant
- `user_id` - AuslÃ¶sender Benutzer
- `backup_job_id` - VerknÃ¼pfter Job
- `action` - Art der Aktion
- `metadata` - ZusÃ¤tzliche Informationen (JSON)
- `ip_address` - IP-Adresse
- `user_agent` - Browser/Client

---

## API-Referenz

### Endpoints

| Method | Endpoint | Beschreibung | Auth |
|--------|----------|--------------|------|
| `POST` | `/api/backup/export` | Export starten | âœ… JWT + Gate |
| `GET` | `/api/backup/jobs` | Alle Jobs auflisten | âœ… JWT + Gate |
| `GET` | `/api/backup/jobs/{id}` | Job-Status abrufen | âœ… JWT + Gate |
| `GET` | `/api/backup/jobs/{id}/download-url` | Signierte Download-URL | âœ… JWT + Gate |
| `DELETE` | `/api/backup/jobs/{id}` | Backup lÃ¶schen | âœ… JWT + Gate |
| `POST` | `/api/backup/import/upload` | Backup hochladen | âœ… JWT + Gate |
| `POST` | `/api/backup/import/{id}/validate` | Backup validieren | âœ… JWT + Gate |
| `POST` | `/api/backup/import/{id}/start` | Import starten | âœ… JWT + Gate + PW |
| `GET` | `/api/backup/download/{id}` | Datei herunterladen | ğŸ”“ Signierter Token |

### Response-Formate

#### Job-Objekt
```json
{
    "id": "uuid-string",
    "type": "export",
    "status": "completed",
    "progress_percent": 100,
    "current_step": null,
    "file_size": 1048576,
    "stats": {
        "invoices": 150,
        "contacts": 42,
        "products": 88
    },
    "error_message": null,
    "started_at": "2026-01-19T18:00:00+00:00",
    "completed_at": "2026-01-19T18:00:30+00:00",
    "created_at": "2026-01-19T17:59:55+00:00",
    "can_download": true
}
```

#### Validierungsergebnis
```json
{
    "valid": true,
    "errors": [],
    "warnings": ["Schema-Version unterscheidet sich"],
    "info": {
        "backup_version": "1.0",
        "app_version": "1.2.0",
        "created_at": "2026-01-18T10:30:00+00:00",
        "tenant_name": "Meine Firma GmbH",
        "total_entities": 1250,
        "total_files": 45
    }
}
```

---

## Backup-Dateiformat

### ZIP-Struktur

```
backup_meine-firma_2026-01-19_183000.zip
â”œâ”€â”€ metadata.json           # Backup-Metadaten
â”œâ”€â”€ manifest.json           # Inhaltsverzeichnis + Checksums
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ tenants.ndjson
â”‚   â”œâ”€â”€ users.ndjson
â”‚   â”œâ”€â”€ accounts.ndjson
â”‚   â”œâ”€â”€ contacts.ndjson
â”‚   â”œâ”€â”€ invoices.ndjson
â”‚   â”œâ”€â”€ invoice_lines.ndjson
â”‚   â””â”€â”€ ...
â””â”€â”€ files/
    â”œâ”€â”€ belege/
    â”‚   â””â”€â”€ {public_id}/
    â”‚       â””â”€â”€ beleg_scan.pdf
    â””â”€â”€ documents/
        â””â”€â”€ {id}/
            â””â”€â”€ attachment.jpg
```

### metadata.json

```json
{
    "backup_version": "1.0",
    "app_name": "AT-Book",
    "app_version": "1.2.0",
    "created_at": "2026-01-19T18:30:00+01:00",
    "tenant_public_id": "abc12345-6789-...",
    "tenant_name": "Meine Firma GmbH",
    "schema_version": "a1b2c3d4e5f6",
    "checksum_algo": "sha256",
    "options": {
        "include_files": true,
        "compression_level": 6
    },
    "created_by": {
        "public_id": "user-uuid-...",
        "email": "admin@firma.de"
    }
}
```

### manifest.json

```json
{
    "entities": [
        {
            "type": "invoices",
            "file": "data/invoices.ndjson",
            "count": 150,
            "checksum": "sha256:abc123..."
        }
    ],
    "files": [
        {
            "path": "files/belege/uuid-123/scan.pdf",
            "original_path": "belege/tenant_1/2026/01/scan.pdf",
            "size": 102400,
            "checksum": "sha256:def456...",
            "entity_type": "beleg",
            "entity_public_id": "uuid-123"
        }
    ],
    "total_entities": 1250,
    "total_files": 45
}
```

### NDJSON-Format

Jede Zeile ist ein JSON-Objekt (Newline-Delimited JSON):

```
{"public_id":"abc-123","invoice_number":"RE-2026-0001","contact_public_id":"xyz-456",...}
{"public_id":"abc-124","invoice_number":"RE-2026-0002","contact_public_id":"xyz-457",...}
```

Vorteile:
- Streaming-fÃ¤hig (keine vollstÃ¤ndige Datei im Speicher)
- Jede Zeile unabhÃ¤ngig parsbar
- Einfache Fehlerbehandlung pro Zeile

---

## Entity-Transformers

### Basisklasse

```php
abstract class BaseTransformer
{
    abstract public function getModelClass(): string;
    abstract public function transform(Model $model): array;
    
    public function getQuery(Tenant $tenant): Builder
    {
        $class = $this->getModelClass();
        return $class::where('tenant_id', $tenant->id)->orderBy('id');
    }
    
    protected function formatDate(?Carbon $date): ?string
    {
        return $date?->toIso8601String();
    }
    
    protected function formatDecimal($value): ?string
    {
        return $value !== null ? number_format($value, 2, '.', '') : null;
    }
    
    protected function getRelatedPublicId($model, string $relation): ?string
    {
        return $model->{$relation}?->public_id;
    }
}
```

### Beispiel: InvoiceTransformer

```php
class InvoiceTransformer extends BaseTransformer
{
    public function getModelClass(): string
    {
        return \App\Models\Invoice::class;
    }

    public function transform(Model $model): array
    {
        return [
            'public_id' => $model->public_id,
            'invoice_number' => $model->invoice_number,
            'contact_public_id' => $this->getRelatedPublicId($model, 'contact'),
            'order_public_id' => $this->getRelatedPublicId($model, 'order'),
            'journal_entry_public_id' => $this->getRelatedPublicId($model, 'journalEntry'),
            'invoice_date' => $this->formatDate($model->invoice_date),
            'due_date' => $this->formatDate($model->due_date),
            'subtotal' => $this->formatDecimal($model->subtotal),
            'tax_amount' => $this->formatDecimal($model->tax_amount),
            'total' => $this->formatDecimal($model->total),
            'status' => $model->status,
            'notes' => $model->notes,
            'created_at' => $this->formatDate($model->created_at),
            'updated_at' => $this->formatDate($model->updated_at),
        ];
    }
}
```

### Registrierte Transformers

| Entity | Transformer | Hat tenant_id |
|--------|-------------|---------------|
| tenants | TenantTransformer | âŒ (ist der Tenant) |
| users | UserTransformer | âœ… |
| accounts | AccountTransformer | âœ… |
| tax_codes | TaxCodeTransformer | âœ… |
| product_categories | ProductCategoryTransformer | âœ… |
| products | ProductTransformer | âœ… |
| contacts | ContactTransformer | âœ… |
| bank_accounts | BankAccountTransformer | âœ… |
| company_settings | CompanySettingTransformer | âœ… |
| quotes | QuoteTransformer | âœ… |
| quote_lines | QuoteLineTransformer | âŒ (Ã¼ber quote) |
| orders | OrderTransformer | âœ… |
| order_lines | OrderLineTransformer | âŒ (Ã¼ber order) |
| delivery_notes | DeliveryNoteTransformer | âœ… |
| delivery_note_lines | DeliveryNoteLineTransformer | âŒ (Ã¼ber delivery_note) |
| invoices | InvoiceTransformer | âœ… |
| invoice_lines | InvoiceLineTransformer | âŒ (Ã¼ber invoice) |
| belege | BelegTransformer | âœ… |
| beleg_lines | BelegLineTransformer | âŒ (Ã¼ber beleg) |
| journal_entries | JournalEntryTransformer | âœ… |
| journal_entry_lines | JournalEntryLineTransformer | âŒ (Ã¼ber journal_entry) |
| inventory_transactions | InventoryTransactionTransformer | âœ… |

---

## Fehlerbehandlung

### Export-Fehler

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      EXPORT FEHLERBEHANDLUNG                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚
â”‚  â”‚ Fehler tritt aufâ”‚                                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚
â”‚           â”‚                                                             â”‚
â”‚           â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ 1. Exception wird gefangen                                          â”‚â”‚
â”‚  â”‚ 2. job->markAsFailed(message, details)                              â”‚â”‚
â”‚  â”‚ 3. BackupAuditLog::log('export_failed', ...)                        â”‚â”‚
â”‚  â”‚ 4. Temp-Dateien werden aufgerÃ¤umt                                   â”‚â”‚
â”‚  â”‚ 5. Exception wird re-thrown                                         â”‚â”‚
â”‚  â”‚ 6. Queue-Worker protokolliert Fehler                                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                         â”‚
â”‚  Frontend zeigt:                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ âŒ Status: Fehlgeschlagen                                           â”‚â”‚
â”‚  â”‚ Fehler:  SQLSTATE[42703]: Undefined column...                       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Import-Fehler

| Fehlertyp | Verhalten |
|-----------|-----------|
| ZIP kann nicht geÃ¶ffnet werden | `valid: false`, Import blockiert |
| metadata.json fehlt | `valid: false`, Import blockiert |
| Cross-Tenant Import | `valid: false`, Import blockiert (FEHLER) |
| Schema-Version unterschiedlich | `valid: true`, Warnung angezeigt |
| Einzelner Datensatz fehlerhaft | Log-Warnung, Import fortgesetzt |
| User mit gleicher E-Mail existiert | Skip, ID-Mapping erstellt |
| Path Traversal erkannt | `valid: false`, Import blockiert |

---

## Queue-Worker

### Konfiguration

```bash
# Worker starten
php artisan queue:work --queue=backups

# Mit Sail
./vendor/bin/sail artisan queue:work --queue=backups

# Wichtig nach Code-Ã„nderungen
./vendor/bin/sail artisan queue:restart
```

### Job-Eigenschaften

```php
// ProcessBackupExportJob
public $queue = 'backups';
public $timeout = 3600;       // 1 Stunde
public $tries = 1;            // Keine Wiederholungsversuche
use WithoutOverlapping;       // Verhindert parallele AusfÃ¼hrung
```

```php
// ProcessBackupImportJob
public $queue = 'backups';
public $timeout = 7200;       // 2 Stunden
public $tries = 1;
use WithoutOverlapping;
```

---

## Bekannte EinschrÃ¤nkungen

1. **Cross-Tenant Import nicht mÃ¶glich** - Backups kÃ¶nnen nur in denselben Tenant wiederhergestellt werden
2. **User mit gleicher E-Mail** - Werden beim Import Ã¼bersprungen, nicht Ã¼berschrieben
3. **documents-Tabelle** - Hat kein tenant_id, wird Ã¼ber Morph-Beziehungen exportiert
4. **GroÃŸe Backups** - Bei >1GB empfohlen: Timeout erhÃ¶hen, Memory-Limit anpassen
5. **Soft-Deletes** - Werden beim Export berÃ¼cksichtigt, aber nicht beim Import wiederhergestellt

---

## Changelog

| Version | Datum | Ã„nderungen |
|---------|-------|------------|
| 1.0 | 2026-01-19 | Initiale Implementierung |

---

*Erstellt am: 2026-01-19*
*Autor: Gemini (AI Assistant)*
